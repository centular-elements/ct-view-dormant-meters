<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-input/paper-input-behavior.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/editor-icons.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-form/iron-form.html">

<link rel="import" href="../ct-editable-switcher/ct-editable-switcher.html">


<!--
`ct-view-settings-dormant-meters`
View the dormant meters template

@demo demo/index.html
-->

<dom-module id="ct-view-settings-dormant-meters">
  <template>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style is="custom-style">
      :host {
        --iron-icon: {
          margin: 6px;
          font-size: 16px;
          opacity: 0.5;
        };

        --paper-input-container:{
          border-top: 1px solid #ccc;
          border-left: 1px solid #ccc;
          border-right: 1px solid #ccc;
          border-bottom: none;
          padding: 0 !important;
        };

        --paper-input-container-input: {
          text-overflow: ellipsis;
          width: calc(100% - 20px);
          margin-left: 10px;
        };

        --paper-input-container-label: {
          margin-left: 10px;
        };
      }

      .hover-full-opacity:hover{
        opacity: 1;
        cursor:pointer;
      }
      .row-easy {
        padding: 10px 0;
      }
      .margin-10v {
        margin: 10px 0;
      }
      .input-suffix {
        margin-right: 10px;
      }
    </style>

    <div class="container-fluid token-input-container">

      <div class="row">
        <div class="col-sm-3 col-sm-offset-9">
          <paper-button
                  class$="btn btn-block [[_computeBtnStyle(_isStateEdit)]]" on-tap="_editBtnHandler" raised>[[_computeButtonText(_isStateEdit)]]</paper-button>
        </div>
      </div>

      <form class="" is="iron-form">
        <div class="row">
          <div class="col-sm-4">
            <div><h4>Dormant Meter Notification Status</h4></div>
          </div>
          <div class="col-sm-8">
            <paper-toggle-button
                    class="input-element margin-10v"
                    id="notificationToggle"
                    active="{{_isToggleActive}}"
                    disabled$="[[!_isStateEdit]]"
            > <span>Notifications are</span> <span>[[_computeToggleText(_isToggleActive)]]</span></paper-toggle-button>
          </div>
        </div>
        <div class="row row-easy">
          <div class="col-sm-4">
            <div><h4>Dormant Meter Threshold</h4></div>
          </div>
          <div class="col-sm-8">
            <ct-editable-switcher edit-mode$="[[_isStateEdit]]">
              <paper-input
                      class="input-element"
                      type="text"
                      allowed-pattern="[0-9\.]"
                      label="Insert Number of days"
                      required$="[[_isToggleActive]]" auto-validate
                      error-message="Please provide the number of days before dormant meter notification is sent"
                      value="">
                <div suffix class="input-suffix"> days</div>
              </paper-input>
            </ct-editable-switcher>
            <small>Number of days a meter can be dormant before a notification is sent</small>
          </div>
        </div>

        <div class="row row-easy">
          <div class="col-sm-4">
            <div><h4>Dormant Meter Email Template</h4></div>
          </div>
          <div class="col-sm-8">
            <ct-editable-switcher edit-mode$="[[_isStateEdit]]">
              <paper-textarea class="input-element" label="Dormant Meter Email Template" required$="[[_isToggleActive]]" auto-validate error-message="Please enter message template" ></paper-textarea>
            </ct-editable-switcher>
            <small>Insert <code>[&shy;[meter_num]&shy;]</code> into template to display the affected meter number</small>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-4">
            <div><h4>Dormant Meter SMS Template</h4></div>
          </div>
          <div class="col-sm-8">
            <ct-editable-switcher edit-mode$="[[_isStateEdit]]">
              <paper-textarea class="input-element" label="Dormant Meter SMS Template" char-counter maxlength="160" required$="[[_isToggleActive]]" auto-validate error-message="Please enter message template" ></paper-textarea>
            </ct-editable-switcher>
            <small>Insert <code>[&shy;[meter_num]&shy;]</code> into template to display the affected meter number</small>
          </div>
        </div>
      </form>
    </div>

    <paper-dialog
            id="disableNotificationsModal"
            modal
            on-iron-overlay-opened="_patchOverlay">
      <h2>Disable Dormant Meter Notification</h2>
      <p>Are you sure you want to disable dormant meter notifications?</p>
      <div class="buttons">
        <paper-button class="btn btn-link" on-tap="_cancelModal">Cancel</paper-button>
        <paper-button class="btn btn-primary" on-tap="_disableNotification" autofocus raised>Yes</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>

      Polymer({
          is: 'ct-view-settings-dormant-meters',

          properties: {
              _isStateEdit : {
                  type: Boolean,
                  value: function() {
                      return false;
                  }
              },

              _isToggleActive : {
                  type: Boolean,
                  observer: '_toggleNotification'
              }

          },

          listeners : {
              'iron-form-presubmit': '_formHandler'
          },

          _computeReadOnly : function(status){
              return (!status);
          },

          _computeButtonText: function(isEdit){
              return (isEdit) ? 'Save Template' : 'Edit Template';
          },

          _computeBtnStyle : function(isEdit){
              return (isEdit) ? "btn-primary" : "btn-default";
          },

          _toggleStatus : function(){
              this._isStateEdit = !this._isStateEdit;
          },

          _editBtnHandler : function(){
              var form = this.$$('form');

              if(this._isStateEdit){
                  if(form.validate()){
                      form.submit();
                  }
              } else {
                  this._toggleStatus();
              }
          },

          _formHandler : function(e){
              var form = this.$$('form');
              e.preventDefault();
              this.fire('updateNotifications', form.serialize());
              this._toggleStatus();
          },

          _computeToggleText : function(isActive) {
              return (isActive) ? 'Enabled' : 'Disabled';
          },

          _disableNotification : function(e){
              this.fire('disableNotification');
              this.$.disableNotificationsModal.close();
          },

          _cancelModal : function(e){
              this.set('_isToggleActive', true);
              this.$.disableNotificationsModal.close();
          },

          _enableNotification : function(e){
              this.fire('enableNotification');
          },

          _toggleNotification : function(newValue, oldValue){

              if(newValue){
                  this._enableNotification();
              } else {
                  if(oldValue !== undefined){
                      this.$.disableNotificationsModal.open();
                  }
              }
          },

          _patchOverlay: function (e) {
              if (e.target.withBackdrop) {
                  e.target.parentNode.insertBefore(e.target.backdropElement, e.target);
              }
          },
      });

  </script>
</dom-module>
